<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹æ¬¡ä»»å‹™ç®¡ç† - PaddleOCR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .content-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .task-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            min-height: 320px;
            display: flex;
            flex-direction: column;
        }

        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .task-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .task-name {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }

        .task-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-created { background: #dbeafe; color: #1e40af; }
        .status-running { background: #fef3c7; color: #92400e; }
        .status-paused { background: #fed7aa; color: #9a3412; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-failed { background: #fee2e2; color: #991b1b; }
        .status-stopped { background: #e5e7eb; color: #374151; }

        .task-info {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-upload {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .task-detail {
            margin-top: 30px;
        }

        .detail-section {
            margin-bottom: 30px;
        }

        .detail-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
            margin-top: 5px;
        }

        .file-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .file-table th,
        .file-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .file-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .file-table tr:hover {
            background: #f9fafb;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .keywords-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .keyword-tag {
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .keyword-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .preview-item {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .preview-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .preview-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
            background: #f3f4f6;
        }

        .preview-info {
            margin-top: 8px;
            font-size: 12px;
        }

        .preview-name {
            font-weight: 600;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .preview-score {
            color: #667eea;
            font-weight: 600;
        }

        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .image-modal.show {
            display: flex;
        }

        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .image-modal-img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
        }

        .image-modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            color: #1f2937;
        }

        .image-modal-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            border-color: #667eea;
            background: #f3f4f6;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .progress-detail {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
        }

        .progress-detail h4 {
            margin-bottom: 10px;
            color: #374151;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ æ‰¹æ¬¡ä»»å‹™ç®¡ç†</h1>
            <div>
                <a href="/" class="btn btn-secondary">è¿”å›é¦–é </a>
                <button class="btn btn-primary" onclick="showCreateTaskModal()">+ æ–°å¢ä»»å‹™</button>
            </div>
        </div>

        <div class="content-box">
            <h2>ä»»å‹™åˆ—è¡¨</h2>
            <div class="tasks-grid" id="tasksGrid">
                <!-- ä»»å‹™å¡ç‰‡å°‡åœ¨æ­¤å‹•æ…‹åŠ è¼‰ -->
            </div>
        </div>

        <div class="content-box task-detail" id="taskDetail" style="display: none;">
            <!-- ä»»å‹™è©³æƒ…å°‡åœ¨æ­¤å‹•æ…‹åŠ è¼‰ -->
        </div>
    </div>

    <!-- æ–°å¢ä»»å‹™ Modal -->
    <div class="modal" id="createTaskModal">
        <div class="modal-content">
            <div class="modal-header">æ–°å¢æ‰¹æ¬¡ä»»å‹™</div>
            <form id="createTaskForm" onsubmit="createTask(event)">
                <div class="form-group">
                    <label class="form-label">ä»»å‹™åç¨±</label>
                    <input type="text" class="form-input" name="task_name" required placeholder="è«‹è¼¸å…¥ä»»å‹™åç¨±">
                </div>
                <div class="form-group">
                    <label class="form-label">ä¾†æºç›®éŒ„è·¯å¾‘</label>
                    <input type="text" class="form-input" name="source_path" required placeholder="ä¾‹å¦‚: C:\Documents\PDFs">
                    <small style="color: #6b7280;">æ”¯æ´æœ¬åœ°è·¯å¾‘å’Œç¶²è·¯ç£ç¢Ÿï¼Œå°‡éè¿´æƒææ‰€æœ‰ PDF æª”æ¡ˆ</small>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createTaskModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">å‰µå»ºä»»å‹™</button>
                </div>
            </form>
        </div>
    </div>

    <!-- é…ç½®ç¬¬ä¸€éšæ®µ Modal -->
    <div class="modal" id="configStage1Modal">
        <div class="modal-content">
            <div class="modal-header">é…ç½®ç¬¬ä¸€éšæ®µ - CLIP åœ–åƒåŒ¹é…</div>
            <form id="configStage1Form" onsubmit="configureStage1(event)">
                <div class="form-group">
                    <label class="form-label">æ­£ä¾‹ç¯„æœ¬åœ–ç‰‡ *</label>
                    <div class="file-upload" onclick="document.getElementById('positiveTemplates').click()">
                        <input type="file" id="positiveTemplates" name="positive_templates" accept="image/*" multiple required>
                        <p id="positiveFilesText">é»æ“Šé¸æ“‡æ­£ä¾‹åœ–ç‰‡ï¼ˆå¯å¤šé¸ï¼‰</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">åä¾‹ç¯„æœ¬åœ–ç‰‡ï¼ˆå¯é¸ï¼‰</label>
                    <div class="file-upload" onclick="document.getElementById('negativeTemplates').click()">
                        <input type="file" id="negativeTemplates" name="negative_templates" accept="image/*" multiple>
                        <p id="negativeFilesText">é»æ“Šé¸æ“‡åä¾‹åœ–ç‰‡ï¼ˆå¯å¤šé¸ï¼‰</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">æ­£ä¾‹ç›¸ä¼¼åº¦é–¾å€¼</label>
                    <input type="number" class="form-input" name="positive_threshold" value="0.95" step="0.01" min="0" max="1">
                </div>
                <div class="form-group">
                    <label class="form-label">åä¾‹ç›¸ä¼¼åº¦é–¾å€¼</label>
                    <input type="number" class="form-input" name="negative_threshold" value="0.55" step="0.01" min="0" max="1">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" name="skip_voided" id="skipVoided">
                        <span class="form-label" style="margin: 0;">è·³éå»¢æ­¢é é¢</span>
                    </label>
                    <small style="color: #6b7280; display: block; margin-top: 5px;">å•Ÿç”¨å¾Œï¼Œç³»çµ±æœƒæª¢æ¸¬å€™é¸é é¢æ˜¯å¦åŒ…å«ã€Œå»¢æ­¢ã€ã€ã€Œä½œå»¢ã€ã€ã€ŒVOIDã€ã€ã€ŒCANCELLEDã€ç­‰é—œéµå­—ï¼Œä¸¦è‡ªå‹•è·³éé€™äº›é é¢</small>
                </div>
                <div class="form-group" id="topNVoidCheckGroup" style="display: none;">
                    <label class="form-label">æª¢æŸ¥å€™é¸æ•¸é‡</label>
                    <input type="number" class="form-input" name="top_n_for_void_check" id="topNVoidCheck" value="5" min="1" max="20">
                    <small style="color: #6b7280;">å°‡æª¢æŸ¥å‰ N å€‹å€™é¸é é¢æ˜¯å¦ç‚ºå»¢æ­¢é é¢ï¼ˆé»˜èª: 5ï¼‰</small>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('configStage1Modal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜é…ç½®ä¸¦é–‹å§‹è™•ç†</button>
                </div>
            </form>
        </div>
    </div>

    <!-- é…ç½®ç¬¬äºŒéšæ®µ Modal -->
    <div class="modal" id="configStage2Modal">
        <div class="modal-content">
            <div class="modal-header">é…ç½®ç¬¬äºŒéšæ®µ - OCR è­˜åˆ¥</div>
            <form id="configStage2Form" onsubmit="configureStage2(event)">
                <div class="form-group">
                    <label class="form-label">é—œéµå­—åˆ—è¡¨</label>
                    <div class="keywords-input">
                        <input type="text" class="form-input" id="keywordInput" placeholder="è¼¸å…¥é—œéµå­—ï¼ˆå¤šå€‹é—œéµå­—ä»¥ç©ºæ ¼åˆ†éš”ï¼‰å¾ŒæŒ‰ Enter">
                    </div>
                    <small style="color: #6b7280; display: block; margin-top: 5px;">æç¤ºï¼šå¯ä¸€æ¬¡è¼¸å…¥å¤šå€‹é—œéµå­—ï¼Œä»¥ç©ºæ ¼åˆ†éš”ï¼Œä¾‹å¦‚ï¼šå ±å‘Šç·¨è™Ÿ è£½ä½œæ—¥æœŸ å ±å‘Šé¡åˆ¥ ç”³è«‹è€… ç”³è«‹è€…åœ°å€ æ³•è¦é …ç›®åç¨± å» ç‰Œ å‹å¼ç³»åˆ— å‹å¼åç¨± æª¢æ¸¬æ©Ÿæ§‹ æª¢æ¸¬å ±å‘Šç·¨è™Ÿ åŸã€Œè»Šè¼›å®‰å…¨æª¢æ¸¬åŸºæº–å¯©æŸ¥å ±å‘Šã€ä¹‹å ±å‘Šç·¨è™Ÿ å‹å¼ç³»åˆ—ç·¨è™Ÿ å‹å¼ç·¨è™Ÿ ç”³è«‹è€…åç¨±</small>
                    <div id="keywordsList"></div>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" name="use_doc_orientation_classify"> æ–‡æª”æ–¹å‘åˆ†é¡</label><br>
                    <label><input type="checkbox" name="use_doc_unwarping"> æ–‡æª”å±•å¹³</label><br>
                    <label><input type="checkbox" name="use_textline_orientation"> æ–‡å­—è¡Œæ–¹å‘æª¢æ¸¬</label><br>
                    <label><input type="checkbox" name="use_seal_recognition"> å°ç« è­˜åˆ¥</label><br>
                    <label><input type="checkbox" name="use_table_recognition" checked> è¡¨æ ¼è­˜åˆ¥</label><br>
                    <label><input type="checkbox" name="use_llm" checked> ä½¿ç”¨ LLM æå–é—œéµå­—</label><br>
                    <label><input type="checkbox" name="use_mllm"> ä½¿ç”¨å¤šæ¨¡æ…‹å¤§æ¨¡å‹ï¼ˆMLLMï¼‰</label>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('configStage2Modal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜é…ç½®ä¸¦é–‹å§‹è™•ç†</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let tasks = [];
        let selectedTaskId = null;
        let keywords = [];
        let isRestartMode = false; // æ¨™è¨˜æ˜¯å¦ç‚ºé‡å•Ÿæ¨¡å¼
        let refreshInterval = null;
        let isPageVisible = true; // è¿½è¹¤é é¢å¯è¦‹æ€§
        let isRefreshing = false; // è¿½è¹¤æ˜¯å¦æœ‰åˆ·æ–°è«‹æ±‚æ­£åœ¨é€²è¡Œä¸­

        // é é¢åŠ è¼‰æ™‚ç²å–ä»»å‹™åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', function() {
            loadAllTasks(); // åˆæ¬¡è¼‰å…¥æ‰€æœ‰ä»»å‹™
            setupFileInputListeners();
            setupKeywordInput();
            setupPageVisibilityListener(); // è¨­ç½®é é¢å¯è¦‹æ€§ç›£è½

            // æ¯ 5 ç§’åªåˆ·æ–°è™•ç†ä¸­çš„ä»»å‹™
            startRefreshInterval();
        });

        /**
         * è¨­ç½®é é¢å¯è¦‹æ€§ç›£è½å™¨
         * ç•¶é é¢åˆ‡æ›åˆ°èƒŒæ™¯æ™‚æš«åœåˆ·æ–°,åˆ‡å›å‰æ™¯æ™‚æ¢å¾©åˆ·æ–°
         */
        function setupPageVisibilityListener() {
            // ç›£è½é é¢å¯è¦‹æ€§è®ŠåŒ–
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // é é¢ä¸å¯è¦‹,æš«åœåˆ·æ–°
                    console.log('é é¢åˆ‡æ›åˆ°èƒŒæ™¯,æš«åœå®šæ™‚åˆ·æ–°');
                    isPageVisible = false;
                    stopRefreshInterval();
                } else {
                    // é é¢å¯è¦‹,æ¢å¾©åˆ·æ–°
                    console.log('é é¢åˆ‡æ›åˆ°å‰æ™¯,æ¢å¾©å®šæ™‚åˆ·æ–°');
                    isPageVisible = true;
                    // ç«‹å³åŸ·è¡Œä¸€æ¬¡åˆ·æ–°,ç„¶å¾Œå•Ÿå‹•å®šæ™‚å™¨
                    refreshRunningTasks();
                    startRefreshInterval();
                }
            });
        }

        /**
         * å•Ÿå‹•å®šæ™‚åˆ·æ–°
         */
        function startRefreshInterval() {
            // ç¢ºä¿æ²’æœ‰é‡è¤‡çš„å®šæ™‚å™¨
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            refreshInterval = setInterval(refreshRunningTasks, 3000);
        }

        /**
         * åœæ­¢å®šæ™‚åˆ·æ–°
         */
        function stopRefreshInterval() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        async function loadAllTasks() {
            /**
             * å®Œæ•´è¼‰å…¥æ‰€æœ‰ä»»å‹™åŠå…¶çµ±è¨ˆè³‡è¨Š
             * ç”¨æ–¼åˆæ¬¡é€²å…¥é é¢æˆ–æ‰‹å‹•åˆ·æ–°
             */
            try {
                const response = await fetch('/api/batch-tasks');
                const data = await response.json();

                if (data.success) {
                    tasks = data.tasks;

                    // ç‚ºæ¯å€‹ä»»å‹™åŠ è¼‰çµ±è¨ˆè³‡è¨Š
                    await Promise.all(tasks.map(async (task) => {
                        try {
                            const statsResponse = await fetch(`/api/batch-tasks/${task.task_id}`);
                            const statsData = await statsResponse.json();
                            if (statsData.success) {
                                task.statistics = statsData.statistics;
                            }
                        } catch (error) {
                            console.error(`è¼‰å…¥ä»»å‹™ ${task.task_id} çµ±è¨ˆè³‡è¨Šå¤±æ•—:`, error);
                        }
                    }));

                    renderTasks();

                    // å¦‚æœæœ‰é¸ä¸­çš„ä»»å‹™ï¼Œåˆ·æ–°è©³æƒ…
                    if (selectedTaskId) {
                        loadTaskDetail(selectedTaskId);
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥ä»»å‹™å¤±æ•—:', error);
            }
        }

        async function refreshRunningTasks() {
            /**
             * åªåˆ·æ–°è™•ç†ä¸­(running)å’Œæš«åœ(paused)ç‹€æ…‹çš„ä»»å‹™
             * æ¸›å°‘ä¸å¿…è¦çš„ API èª¿ç”¨,æå‡æ•ˆèƒ½
             * é˜²æ­¢é‡è¤‡è«‹æ±‚:å¦‚æœä¸Šä¸€æ¬¡åˆ·æ–°å°šæœªå®Œæˆ,å‰‡è·³éæ­¤æ¬¡åˆ·æ–°
             */

            // æª¢æŸ¥æ˜¯å¦æœ‰è«‹æ±‚æ­£åœ¨é€²è¡Œä¸­
            if (isRefreshing) {
                console.log('ä¸Šä¸€æ¬¡åˆ·æ–°è«‹æ±‚å°šæœªå®Œæˆ,è·³éæ­¤æ¬¡åˆ·æ–°');
                return;
            }

            try {
                // æ¨™è¨˜é–‹å§‹åˆ·æ–°
                isRefreshing = true;

                // æ‰¾å‡ºéœ€è¦åˆ·æ–°çš„ä»»å‹™(running æˆ– paused ç‹€æ…‹)
                const tasksToRefresh = tasks.filter(task =>
                    task.status === 'running' || task.status === 'paused'
                );

                if (tasksToRefresh.length === 0) {
                    // æ²’æœ‰éœ€è¦åˆ·æ–°çš„ä»»å‹™,è·³é
                    return;
                }

                console.log(`åˆ·æ–° ${tasksToRefresh.length} å€‹è™•ç†ä¸­çš„ä»»å‹™`);

                // åªç‚ºè™•ç†ä¸­çš„ä»»å‹™æ›´æ–°çµ±è¨ˆè³‡è¨Š
                await Promise.all(tasksToRefresh.map(async (task) => {
                    try {
                        const statsResponse = await fetch(`/api/batch-tasks/${task.task_id}`);
                        const statsData = await statsResponse.json();
                        if (statsData.success) {
                            // æ›´æ–°ä»»å‹™ç‹€æ…‹å’Œçµ±è¨ˆè³‡è¨Š
                            const taskIndex = tasks.findIndex(t => t.task_id === task.task_id);
                            if (taskIndex !== -1) {
                                tasks[taskIndex].status = statsData.task.status;
                                tasks[taskIndex].stage = statsData.task.stage;
                                tasks[taskIndex].progress = statsData.task.progress;
                                tasks[taskIndex].statistics = statsData.statistics;
                            }
                        }
                    } catch (error) {
                        console.error(`åˆ·æ–°ä»»å‹™ ${task.task_id} çµ±è¨ˆè³‡è¨Šå¤±æ•—:`, error);
                    }
                }));

                renderTasks();

                // å¦‚æœé¸ä¸­çš„ä»»å‹™æ˜¯è™•ç†ä¸­ç‹€æ…‹,ä¹Ÿåˆ·æ–°è©³æƒ…
                if (selectedTaskId) {
                    const selectedTask = tasks.find(t => t.task_id === selectedTaskId);
                    if (selectedTask && (selectedTask.status === 'running' || selectedTask.status === 'paused')) {
                        loadTaskDetail(selectedTaskId);
                    }
                }
            } catch (error) {
                console.error('åˆ·æ–°è™•ç†ä¸­ä»»å‹™å¤±æ•—:', error);
            } finally {
                // ç„¡è«–æˆåŠŸæˆ–å¤±æ•—,éƒ½æ¨™è¨˜åˆ·æ–°å®Œæˆ
                isRefreshing = false;
            }
        }

        async function loadTasks() {
            /**
             * ä¿ç•™æ­¤å‡½æ•¸ä»¥ä¾›æ‰‹å‹•åˆ·æ–°ä½¿ç”¨
             * å¯¦éš›ä¸Šèª¿ç”¨ loadAllTasks
             */
            await loadAllTasks();
        }

        function renderTasks() {
            const grid = document.getElementById('tasksGrid');

            if (tasks.length === 0) {
                grid.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 40px;">å°šç„¡ä»»å‹™ï¼Œè«‹é»æ“Šã€Œæ–°å¢ä»»å‹™ã€é–‹å§‹</p>';
                return;
            }

            grid.innerHTML = tasks.map(task => {
                const stats = task.statistics || {};
                const total = stats.total_files || task.total_files || 0;
                const stage1Progress = total > 0 ? ((stats.stage1_completed || 0) + (stats.stage1_failed || 0)) / total * 100 : 0;
                const stage2Progress = total > 0 ? ((stats.stage2_completed || 0) + (stats.stage2_failed || 0)) / total * 100 : 0;
                
                return `
                <div class="task-card ${task.task_id === selectedTaskId ? 'active' : ''}" onclick="selectTask('${task.task_id}')">
                    <div class="task-header">
                        <div class="task-name">${task.task_name}</div>
                        <span class="task-status status-${task.status}">${getStatusText(task.status)}</span>
                    </div>
                    <div class="task-info">ğŸ“ è·¯å¾‘: ${task.source_path}</div>
                    <div class="task-info">ğŸ“„ æª”æ¡ˆæ•¸: ${total} å€‹</div>
                    ${task.stage ? `<div class="task-info">ğŸ”„ ç•¶å‰éšæ®µ: ${task.stage === 1 ? 'ç¬¬ä¸€éšæ®µ (CLIP åŒ¹é…)' : 'ç¬¬äºŒéšæ®µ (OCR è­˜åˆ¥)'}</div>` : ''}
                    <div class="task-info">â±ï¸ å»ºç«‹æ™‚é–“: ${formatDate(task.created_at)}</div>
                    ${((stats.stage1_failed || 0) + (stats.stage2_failed || 0)) > 0 ?
                        `<div class="task-info" style="color: #dc2626; font-weight: 600;">âš ï¸ å…± ${(stats.stage1_failed || 0) + (stats.stage2_failed || 0)} å€‹æª”æ¡ˆè™•ç†å¤±æ•—</div>`
                        : ''}
                    
                    <div style="margin-top: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <small style="color: #374151; font-weight: 600;">ğŸ“Š ç¬¬ä¸€éšæ®µ</small>
                            <small style="color: #6b7280;">${stage1Progress.toFixed(1)}%</small>
                        </div>
                        <div class="progress-bar" style="height: 6px;">
                            <div class="progress-fill" style="width: ${stage1Progress}%"></div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 3px; font-size: 11px; color: #6b7280;">
                            <span>â³ ${stats.stage1_pending || 0}</span>
                            <span style="color: #10b981;">âœ… ${stats.stage1_completed || 0}</span>
                            <span style="color: #ef4444;">âŒ ${stats.stage1_failed || 0}</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <small style="color: #374151; font-weight: 600;">ğŸ“ ç¬¬äºŒéšæ®µ</small>
                            <small style="color: #6b7280;">${stage2Progress.toFixed(1)}%</small>
                        </div>
                        <div class="progress-bar" style="height: 6px;">
                            <div class="progress-fill" style="width: ${stage2Progress}%"></div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 3px; font-size: 11px; color: #6b7280;">
                            <span>â³ ${stats.stage2_pending || 0}</span>
                            <span style="color: #10b981;">âœ… ${stats.stage2_completed || 0}</span>
                            <span style="color: #ef4444;">âŒ ${stats.stage2_failed || 0}</span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function selectTask(taskId) {
            selectedTaskId = taskId;
            renderTasks();
            loadTaskDetail(taskId);
        }

        async function loadTaskDetail(taskId) {
            try {
                const response = await fetch(`/api/batch-tasks/${taskId}`);
                const data = await response.json();

                if (data.success) {
                    renderTaskDetail(data.task, data.statistics, data.keywords);
                }
            } catch (error) {
                console.error('è¼‰å…¥ä»»å‹™è©³æƒ…å¤±æ•—:', error);
            }
        }

        function renderTaskDetail(task, stats, keywords) {
            const detailDiv = document.getElementById('taskDetail');
            detailDiv.style.display = 'block';

            detailDiv.innerHTML = `
                <div class="detail-title">ä»»å‹™è©³æƒ…: ${task.task_name}</div>

                <div class="detail-section">
                    <h3>çµ±è¨ˆè³‡è¨Š</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${stats.total_files || 0}</div>
                            <div class="stat-label">ç¸½æª”æ¡ˆæ•¸</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.stage1_completed || 0}</div>
                            <div class="stat-label">ç¬¬ä¸€éšæ®µå®Œæˆ</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.stage2_completed || 0}</div>
                            <div class="stat-label">ç¬¬äºŒéšæ®µå®Œæˆ</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${(stats.avg_matching_score || 0).toFixed(2)}</div>
                            <div class="stat-label">å¹³å‡åŒ¹é…åˆ†æ•¸</div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>é—œéµå­—</h3>
                    <div>
                        ${keywords.length > 0 ? keywords.map(kw => `<span class="keyword-tag">${kw}</span>`).join(' ') : '<p style="color: #6b7280;">å°šæœªé…ç½®é—œéµå­—</p>'}
                    </div>
                </div>

                <div class="detail-section">
                    <h3>æ“ä½œ</h3>
                    <div class="action-buttons">
                        ${renderActionButtons(task)}
                    </div>
                </div>
            `;
        }

        function renderActionButtons(task) {
            let buttons = [];

            // æŸ¥çœ‹è©³æƒ…æŒ‰éˆ•ï¼ˆæœ‰ç¬¬ä¸€éšæ®µå®Œæˆçš„æª”æ¡ˆæ™‚é¡¯ç¤ºï¼‰
            buttons.push(`<a href="/batch-tasks/${task.task_id}/detail" class="btn btn-primary" target="_blank">ğŸ“Š æŸ¥çœ‹è©³æƒ…</a>`);

            // å¤±æ•—ç‹€æ…‹çš„ç¹¼çºŒåŸ·è¡ŒæŒ‰éˆ•
            if (task.status === 'failed') {
                buttons.push('<button class="btn btn-warning" onclick="resumeFailedTask()" style="background: #f59e0b;">ğŸ”„ å¾å¤±æ•—é»ç¹¼çºŒåŸ·è¡Œ</button>');
                buttons.push('<button class="btn btn-secondary" onclick="restartFromBeginning()">ğŸ” å¾é ­é‡æ–°é–‹å§‹</button>');
            }

            // ç¬¬ä¸€éšæ®µæ§åˆ¶
            if (!task.stage1_config) {
                buttons.push('<button class="btn btn-primary" onclick="showConfigStage1Modal()">é…ç½®ç¬¬ä¸€éšæ®µ</button>');
            } else if (task.status === 'created' || task.status === 'stopped') {
                buttons.push('<button class="btn btn-success" onclick="startStage1()">é–‹å§‹ç¬¬ä¸€éšæ®µ</button>');
                buttons.push('<button class="btn btn-secondary" onclick="showConfigStage1Modal()">é‡æ–°é…ç½®ç¬¬ä¸€éšæ®µ</button>');
            } else if (task.status === 'running' && task.stage === 1) {
                buttons.push('<button class="btn btn-warning" onclick="pauseTask()">æš«åœ</button>');
                buttons.push('<button class="btn btn-danger" onclick="stopTask()">åœæ­¢</button>');
            } else if (task.status === 'paused') {
                buttons.push('<button class="btn btn-success" onclick="resumeTask()">æ¢å¾©</button>');
                buttons.push('<button class="btn btn-danger" onclick="stopTask()">åœæ­¢</button>');
            } else if (task.status === 'stage1_completed') {
                buttons.push('<button class="btn btn-primary" onclick="showConfigStage2Modal()">é…ç½®ç¬¬äºŒéšæ®µ</button>');
                buttons.push('<button class="btn btn-secondary" onclick="restartStage1()">é‡æ–°åŸ·è¡Œç¬¬ä¸€éšæ®µ</button>');
            }

            // ç¬¬äºŒéšæ®µæ§åˆ¶
            if (task.stage2_config && task.status === 'stage1_completed') {
                buttons.push('<button class="btn btn-success" onclick="startStage2()">é–‹å§‹ç¬¬äºŒéšæ®µ</button>');
            } else if (task.status === 'running' && task.stage === 2) {
                buttons.push('<button class="btn btn-warning" onclick="pauseTask()">æš«åœ</button>');
                buttons.push('<button class="btn btn-danger" onclick="stopTask()">åœæ­¢</button>');
            } else if (task.status === 'completed') {
                buttons.push('<button class="btn btn-success" onclick="exportTask()">åŒ¯å‡º Excel</button>');
                buttons.push('<button class="btn btn-secondary" onclick="restartStage2()">é‡æ–°åŸ·è¡Œç¬¬äºŒéšæ®µ</button>');
            }

            // åˆªé™¤ä»»å‹™
            buttons.push('<button class="btn btn-danger" onclick="deleteTask()">åˆªé™¤ä»»å‹™</button>');

            return buttons.join('');
        }

        function showCreateTaskModal() {
            document.getElementById('createTaskModal').classList.add('show');
        }

        function showConfigStage1Modal() {
            isRestartMode = false; // é è¨­ç‚ºéé‡å•Ÿæ¨¡å¼
            document.getElementById('configStage1Modal').classList.add('show');
        }

        function showConfigStage2Modal() {
            isRestartMode = false; // é è¨­ç‚ºéé‡å•Ÿæ¨¡å¼
            if (keywords.length === 0) {
                keywords = [];
                document.getElementById('keywordsList').innerHTML = '';
            }
            document.getElementById('configStage2Modal').classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        async function createTask(event) {
            event.preventDefault();
            const formData = new FormData(event.target);

            try {
                const response = await fetch('/api/batch-tasks/create', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    closeModal('createTaskModal');
                    event.target.reset();
                    loadTasks();
                } else {
                    alert('å‰µå»ºå¤±æ•—: ' + data.error);
                }
            } catch (error) {
                alert('å‰µå»ºå¤±æ•—: ' + error);
            }
        }

        async function configureStage1(event) {
            event.preventDefault();
            const formData = new FormData(event.target);

            try {
                // å…ˆä¿å­˜é…ç½®
                const configResponse = await fetch(`/api/batch-tasks/${selectedTaskId}/stage1/config`, {
                    method: 'POST',
                    body: formData
                });
                const configData = await configResponse.json();

                if (!configData.success) {
                    alert('é…ç½®å¤±æ•—: ' + configData.error);
                    return;
                }

                alert('é…ç½®å·²ä¿å­˜');
                closeModal('configStage1Modal');

                // å¦‚æœæ˜¯é‡å•Ÿæ¨¡å¼ï¼Œèª¿ç”¨é‡å•Ÿ APIï¼›å¦å‰‡é–‹å§‹ç¬¬ä¸€éšæ®µ
                if (isRestartMode) {
                    const restartResponse = await fetch(`/api/batch-tasks/${selectedTaskId}/stage1/restart`, {
                        method: 'POST'
                    });
                    const restartData = await restartResponse.json();

                    if (restartData.success) {
                        alert('ç¬¬ä¸€éšæ®µå·²é‡æ–°å•Ÿå‹•');
                        loadTasks();
                    } else {
                        alert('é‡å•Ÿå¤±æ•—: ' + restartData.error);
                    }
                } else {
                    // è‡ªå‹•é–‹å§‹ç¬¬ä¸€éšæ®µ
                    startStage1();
                }
            } catch (error) {
                alert('æ“ä½œå¤±æ•—: ' + error);
            }
        }

        async function configureStage2(event) {
            event.preventDefault();

            if (keywords.length === 0) {
                alert('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹é—œéµå­—');
                return;
            }

            const formData = new FormData(event.target);
            formData.set('keywords', JSON.stringify(keywords));

            try {
                // å…ˆä¿å­˜é…ç½®
                const configResponse = await fetch(`/api/batch-tasks/${selectedTaskId}/stage2/config`, {
                    method: 'POST',
                    body: formData
                });
                const configData = await configResponse.json();

                if (!configData.success) {
                    alert('é…ç½®å¤±æ•—: ' + configData.error);
                    return;
                }

                alert('é…ç½®å·²ä¿å­˜');
                closeModal('configStage2Modal');

                // å¦‚æœæ˜¯é‡å•Ÿæ¨¡å¼ï¼Œèª¿ç”¨é‡å•Ÿ APIï¼›å¦å‰‡é–‹å§‹ç¬¬äºŒéšæ®µ
                if (isRestartMode) {
                    const restartResponse = await fetch(`/api/batch-tasks/${selectedTaskId}/stage2/restart`, {
                        method: 'POST'
                    });
                    const restartData = await restartResponse.json();

                    if (restartData.success) {
                        alert('ç¬¬äºŒéšæ®µå·²é‡æ–°å•Ÿå‹•');
                        loadTasks();
                    } else {
                        alert('é‡å•Ÿå¤±æ•—: ' + restartData.error);
                    }
                } else {
                    // è‡ªå‹•é–‹å§‹ç¬¬äºŒéšæ®µ
                    startStage2();
                }
            } catch (error) {
                alert('æ“ä½œå¤±æ•—: ' + error);
            }
        }

        async function startStage1() {
            try {
                const response = await fetch(`/api/batch-tasks/${selectedTaskId}/stage1/start`, { method: 'POST' });
                const data = await response.json();
                alert(data.success ? 'ç¬¬ä¸€éšæ®µå·²å•Ÿå‹•' : 'å•Ÿå‹•å¤±æ•—: ' + data.error);
                loadTasks();
            } catch (error) {
                alert('å•Ÿå‹•å¤±æ•—: ' + error);
            }
        }

        async function startStage2() {
            try {
                const response = await fetch(`/api/batch-tasks/${selectedTaskId}/stage2/start`, { method: 'POST' });
                const data = await response.json();
                alert(data.success ? 'ç¬¬äºŒéšæ®µå·²å•Ÿå‹•' : 'å•Ÿå‹•å¤±æ•—: ' + data.error);
                loadTasks();
            } catch (error) {
                alert('å•Ÿå‹•å¤±æ•—: ' + error);
            }
        }

        async function pauseTask() {
            try {
                const response = await fetch(`/api/batch-tasks/${selectedTaskId}/pause`, { method: 'POST' });
                const data = await response.json();
                alert(data.success ? 'ä»»å‹™å·²æš«åœ' : 'æš«åœå¤±æ•—: ' + data.error);
                loadTasks();
            } catch (error) {
                alert('æš«åœå¤±æ•—: ' + error);
            }
        }

        async function resumeTask() {
            try {
                const response = await fetch(`/api/batch-tasks/${selectedTaskId}/resume`, { method: 'POST' });
                const data = await response.json();
                alert(data.success ? 'ä»»å‹™å·²æ¢å¾©' : 'æ¢å¾©å¤±æ•—: ' + data.error);
                loadTasks();
            } catch (error) {
                alert('æ¢å¾©å¤±æ•—: ' + error);
            }
        }

        async function stopTask() {
            if (!confirm('ç¢ºå®šè¦åœæ­¢ä»»å‹™å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/batch-tasks/${selectedTaskId}/stop`, { method: 'POST' });
                const data = await response.json();
                alert(data.success ? 'ä»»å‹™å·²åœæ­¢' : 'åœæ­¢å¤±æ•—: ' + data.error);
                loadTasks();
            } catch (error) {
                alert('åœæ­¢å¤±æ•—: ' + error);
            }
        }

        async function restartStage1() {
            if (!confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹ç¬¬ä¸€éšæ®µå—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰ç¬¬ä¸€éšæ®µçš„çµæœã€‚\n\nè«‹åœ¨ä¸‹ä¸€å€‹å°è©±æ¡†ä¸­èª¿æ•´é…ç½®åƒæ•¸ã€‚')) return;

            // è¨­ç½®ç‚ºé‡å•Ÿæ¨¡å¼
            isRestartMode = true;

            // è¼‰å…¥ç•¶å‰é…ç½®ä¸¦é¡¯ç¤ºé…ç½®æ¨¡æ…‹æ¡†
            await loadStage1ConfigForRestart();
            document.getElementById('configStage1Modal').classList.add('show');
        }

        async function loadStage1ConfigForRestart() {
            try {
                const response = await fetch(`/api/batch-tasks/${selectedTaskId}`);
                const data = await response.json();

                if (data.success && data.task.stage1_config) {
                    const config = JSON.parse(data.task.stage1_config);

                    // å¡«å……è¡¨å–®
                    const posThresholdInput = document.querySelector('input[name="positive_threshold"]');
                    const negThresholdInput = document.querySelector('input[name="negative_threshold"]');
                    const skipVoidedCheckbox = document.getElementById('skipVoided');
                    const topNVoidCheckInput = document.getElementById('topNVoidCheck');
                    const topNVoidCheckGroup = document.getElementById('topNVoidCheckGroup');

                    if (posThresholdInput) posThresholdInput.value = config.positive_threshold || 0.95;
                    if (negThresholdInput) negThresholdInput.value = config.negative_threshold || 0.55;

                    // è¨­ç½®è·³éå»¢æ­¢é¸é …
                    if (skipVoidedCheckbox) {
                        skipVoidedCheckbox.checked = config.skip_voided || false;
                        // é¡¯ç¤º/éš±è—æª¢æŸ¥å€™é¸æ•¸é‡é¸é …
                        if (topNVoidCheckGroup) {
                            topNVoidCheckGroup.style.display = config.skip_voided ? 'block' : 'none';
                        }
                    }
                    if (topNVoidCheckInput) {
                        topNVoidCheckInput.value = config.top_n_for_void_check || 5;
                    }

                    console.log('å·²è¼‰å…¥ç¬¬ä¸€éšæ®µé…ç½®:', config);
                }
            } catch (error) {
                console.error('è¼‰å…¥é…ç½®å¤±æ•—:', error);
            }
        }

        async function restartStage2() {
            if (!confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹ç¬¬äºŒéšæ®µå—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰ç¬¬äºŒéšæ®µçš„çµæœã€‚\n\nè«‹åœ¨ä¸‹ä¸€å€‹å°è©±æ¡†ä¸­èª¿æ•´é…ç½®åƒæ•¸ã€‚')) return;

            // è¨­ç½®ç‚ºé‡å•Ÿæ¨¡å¼
            isRestartMode = true;

            // è¼‰å…¥ç•¶å‰é…ç½®ä¸¦é¡¯ç¤ºé…ç½®æ¨¡æ…‹æ¡†
            await loadStage2ConfigForRestart();
            document.getElementById('configStage2Modal').classList.add('show');
        }

        async function loadStage2ConfigForRestart() {
            try {
                const response = await fetch(`/api/batch-tasks/${selectedTaskId}`);
                const data = await response.json();

                if (data.success && data.task.stage2_config) {
                    const config = JSON.parse(data.task.stage2_config);

                    // å¡«å……è¡¨å–®
                    document.getElementById('useLLM').checked = config.use_llm !== false;
                    document.querySelector('[name="use_mllm"]').checked = config.use_mllm || false;
                    document.getElementById('useOrientation').checked = config.use_doc_orientation_classify || false;
                    document.getElementById('useUnwarping').checked = config.use_doc_unwarping || false;
                    document.getElementById('useTextlineOrientation').checked = config.use_textline_orientation || false;
                    document.getElementById('useSealRecognition').checked = config.use_seal_recognition || false;
                    document.getElementById('useTableRecognition').checked = config.use_table_recognition !== false;

                    console.log('å·²è¼‰å…¥ç¬¬äºŒéšæ®µé…ç½®:', config);
                }

                // è¼‰å…¥é—œéµå­—
                const keywordsResponse = await fetch(`/api/batch-tasks/${selectedTaskId}/keywords`);
                const keywordsData = await keywordsResponse.json();

                if (keywordsData.success && keywordsData.keywords) {
                    keywords = keywordsData.keywords;
                    renderKeywords();
                }
            } catch (error) {
                console.error('è¼‰å…¥é…ç½®å¤±æ•—:', error);
            }
        }

        async function deleteTask() {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ä»»å‹™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚')) return;

            try {
                const response = await fetch(`/api/batch-tasks/${selectedTaskId}`, { method: 'DELETE' });
                const data = await response.json();

                if (data.success) {
                    alert('ä»»å‹™å·²åˆªé™¤');
                    selectedTaskId = null;
                    document.getElementById('taskDetail').style.display = 'none';
                    loadTasks();
                } else {
                    alert('åˆªé™¤å¤±æ•—: ' + data.error);
                }
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—: ' + error);
            }
        }

        async function resumeFailedTask() {
            const task = tasks.find(t => t.task_id === selectedTaskId);
            if (!task) {
                alert('æ‰¾ä¸åˆ°ä»»å‹™');
                return;
            }

            const stats = task.statistics || {};
            const stage = task.stage;
            const stageName = stage === 1 ? 'ç¬¬ä¸€éšæ®µ (CLIP åŒ¹é…)' : 'ç¬¬äºŒéšæ®µ (OCR è­˜åˆ¥)';
            const pending = stage === 1 ? (stats.stage1_pending || 0) : (stats.stage2_pending || 0);
            const completed = stage === 1 ? (stats.stage1_completed || 0) : (stats.stage2_completed || 0);
            const failed = stage === 1 ? (stats.stage1_failed || 0) : (stats.stage2_failed || 0);

            const message = `å³å°‡å¾å¤±æ•—é»ç¹¼çºŒåŸ·è¡Œä»»å‹™:\n\n` +
                          `ç•¶å‰éšæ®µ: ${stageName}\n` +
                          `å·²å®Œæˆ: ${completed} å€‹æª”æ¡ˆ\n` +
                          `å·²å¤±æ•—: ${failed} å€‹æª”æ¡ˆ\n` +
                          `å¾…è™•ç†: ${pending} å€‹æª”æ¡ˆ\n\n` +
                          `æ­¤æ“ä½œå°‡ç¹¼çºŒè™•ç†å‰©é¤˜çš„ ${pending} å€‹æª”æ¡ˆ,\n` +
                          `å·²å®Œæˆå’Œå·²å¤±æ•—çš„æª”æ¡ˆä¸æœƒé‡æ–°è™•ç†ã€‚\n\n` +
                          `ç¢ºå®šè¦ç¹¼çºŒå—?`;

            if (!confirm(message)) return;

            try {
                // èª¿æ•´å¤±æ•—é»ç¹¼çºŒåŸ·è¡Œçš„ API è·¯å¾‘
                const response = await fetch(`/api/batch-tasks/${selectedTaskId}/resume`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert(`âœ… ${data.message}\n\nå³å°‡é–‹å§‹è™•ç†å‰©é¤˜æª”æ¡ˆ...`);
                    loadTasks();
                } else {
                    alert(`âŒ ç¹¼çºŒåŸ·è¡Œå¤±æ•—:\n${data.error}`);
                    if (data.traceback) {
                        console.error('éŒ¯èª¤è¿½è¹¤:', data.traceback);
                    }
                }
            } catch (error) {
                alert('ç¹¼çºŒåŸ·è¡Œå¤±æ•—: ' + error);
                console.error(error);
            }
        }

        async function restartFromBeginning() {
            const task = tasks.find(t => t.task_id === selectedTaskId);
            if (!task) {
                alert('æ‰¾ä¸åˆ°ä»»å‹™');
                return;
            }

            const stage = task.stage;
            const stageName = stage === 1 ? 'ç¬¬ä¸€éšæ®µ' : 'ç¬¬äºŒéšæ®µ';

            if (!confirm(`ç¢ºå®šè¦å¾é ­é‡æ–°é–‹å§‹${stageName}å—?\n\nâš ï¸ è­¦å‘Š: é€™å°‡æ¸…é™¤è©²éšæ®µçš„æ‰€æœ‰çµæœ!\næ‰€æœ‰æª”æ¡ˆéƒ½æœƒé‡æ–°è™•ç†ã€‚`)) {
                return;
            }

            if (stage === 1) {
                await restartStage1();
            } else {
                await restartStage2();
            }
        }

        async function exportTask() {
            window.location.href = `/api/batch-tasks/${selectedTaskId}/export`;
        }

        function setupFileInputListeners() {
            document.getElementById('positiveTemplates').addEventListener('change', function(e) {
                const count = e.target.files.length;
                document.getElementById('positiveFilesText').textContent = count > 0 ? `å·²é¸æ“‡ ${count} å€‹æª”æ¡ˆ` : 'é»æ“Šé¸æ“‡æ­£ä¾‹åœ–ç‰‡ï¼ˆå¯å¤šé¸ï¼‰';
            });

            document.getElementById('negativeTemplates').addEventListener('change', function(e) {
                const count = e.target.files.length;
                document.getElementById('negativeFilesText').textContent = count > 0 ? `å·²é¸æ“‡ ${count} å€‹æª”æ¡ˆ` : 'é»æ“Šé¸æ“‡åä¾‹åœ–ç‰‡ï¼ˆå¯å¤šé¸ï¼‰';
            });

            // ç›£è½è·³éå»¢æ­¢è¤‡é¸æ¡†è®ŠåŒ–
            document.getElementById('skipVoided').addEventListener('change', function(e) {
                const topNGroup = document.getElementById('topNVoidCheckGroup');
                topNGroup.style.display = e.target.checked ? 'block' : 'none';
            });
        }

        function setupKeywordInput() {
            const input = document.getElementById('keywordInput');
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const inputValue = input.value.trim();

                    if (inputValue) {
                        // ä»¥ç©ºæ ¼åˆ†å‰²å¤šå€‹é—œéµå­—
                        const newKeywords = inputValue.split(/\s+/).filter(kw => kw.trim() !== '');

                        // æ·»åŠ ä¸é‡è¤‡çš„é—œéµå­—
                        newKeywords.forEach(keyword => {
                            if (keyword && !keywords.includes(keyword)) {
                                keywords.push(keyword);
                            }
                        });

                        renderKeywords();
                        input.value = '';
                    }
                }
            });
        }

        function renderKeywords() {
            const list = document.getElementById('keywordsList');
            list.innerHTML = keywords.map((kw, idx) => `
                <span class="keyword-tag">
                    ${kw}
                    <button type="button" onclick="removeKeyword(${idx})">Ã—</button>
                </span>
            `).join(' ');
        }

        function removeKeyword(index) {
            keywords.splice(index, 1);
            renderKeywords();
        }

        function getStatusText(status) {
            const statusMap = {
                'created': 'å·²å»ºç«‹',
                'running': 'è™•ç†ä¸­',
                'paused': 'å·²æš«åœ',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±æ•—',
                'stopped': 'å·²åœæ­¢',
                'stage1_completed': 'ç¬¬ä¸€éšæ®µå®Œæˆ'
            };
            return statusMap[status] || status;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-TW');
        }

        function getStage1Progress(stats) {
            const total = stats.total_files || 0;
            if (total === 0) return 0;
            const completed = stats.stage1_completed || 0;
            const failed = stats.stage1_failed || 0;
            return ((completed + failed) / total) * 100;
        }

        function getStage2Progress(stats) {
            const total = stats.total_files || 0;
            if (total === 0) return 0;
            const completed = stats.stage2_completed || 0;
            const failed = stats.stage2_failed || 0;
            return ((completed + failed) / total) * 100;
        }

        // é»æ“Š modal å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        }
    </script>
</body>
</html>
