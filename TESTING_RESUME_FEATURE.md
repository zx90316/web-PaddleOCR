# 批次任務恢復功能測試指南

## 快速測試步驟

### 1. 正常場景測試

#### 步驟 A: 創建並開始任務
```bash
# 1. 啟動服務
python start_services.py

# 2. 打開瀏覽器
http://localhost:8080/batch-tasks

# 3. 創建新任務
- 任務名稱: 測試恢復功能
- 來源路徑: 選擇包含 PDF 的資料夾(建議 50-100 個檔案)

# 4. 配置並開始第一階段
- 上傳正例/反例範本
- 設定閾值
- 開始處理
```

#### 步驟 B: 模擬中途失敗
```bash
# 方法 1: 停止 CLIP 服務(模擬網路中斷)
# 等待處理約 30% 檔案後,關閉 CLIP 服務視窗

# 方法 2: 修改程式碼強制失敗(用於開發測試)
# 在 batch_processor.py 的 process_task_stage1_worker() 中
# 約 270 行附近加入:
if len(pending_files) > 0 and processed_count >= 10:
    raise Exception("測試用的模擬錯誤")
```

#### 步驟 C: 觀察失敗狀態
```
1. 任務卡片顯示狀態為「失敗」(紅色)
2. 統計顯示:
   - 已完成: 約 30 個
   - 已失敗: 0 個
   - 待處理: 約 70 個
3. 點擊任務查看詳情
```

#### 步驟 D: 測試恢復功能
```
1. 重啟 CLIP 服務(如果之前關閉)

2. 在任務詳情頁面,應該看到兩個按鈕:
   - 🔄 從失敗點繼續執行
   - 🔁 從頭重新開始

3. 點擊「從失敗點繼續執行」

4. 確認對話框會顯示:
   當前階段: 第一階段 (CLIP 匹配)
   已完成: 30 個檔案
   已失敗: 0 個檔案
   待處理: 70 個檔案

   此操作將繼續處理剩餘的 70 個檔案,
   已完成和已失敗的檔案不會重新處理。

5. 點擊「確定」
```

#### 步驟 E: 驗證結果
```
觀察事項:
1. 任務狀態變為「處理中」
2. 進度條從 30% 開始增長
3. 不會重新處理前 30 個檔案
4. 最終所有 100 個檔案都完成

驗證資料庫:
SELECT
    COUNT(*) as total,
    SUM(CASE WHEN stage1_status='completed' THEN 1 ELSE 0 END) as completed,
    SUM(CASE WHEN stage1_status='failed' THEN 1 ELSE 0 END) as failed,
    SUM(CASE WHEN stage1_status='pending' THEN 1 ELSE 0 END) as pending
FROM batch_files
WHERE task_id = 'your_task_id';

預期結果:
- total: 100
- completed: 100
- failed: 0
- pending: 0
```

### 2. 邊界條件測試

#### 測試 2A: 沒有待處理檔案
```
場景: 所有檔案都已完成或失敗

步驟:
1. 等待任務完全執行完畢
2. 手動將任務狀態改為 'failed'
   UPDATE batch_tasks SET status='failed' WHERE task_id='xxx';
3. 嘗試點擊「從失敗點繼續執行」

預期結果:
- 後端檢測到 pending_count=0
- 不會啟動處理
- 日誌輸出: "沒有待處理的檔案,任務已完成"
```

#### 測試 2B: 任務狀態不符合
```
場景: 嘗試對 running 狀態的任務使用恢復功能

步驟:
1. 任務正在處理中(status='running')
2. 檢查按鈕是否顯示

預期結果:
- 不會顯示「從失敗點繼續執行」按鈕
- 只顯示「暫停」和「停止」按鈕
```

#### 測試 2C: 第二階段恢復
```
場景: 第二階段處理到一半失敗

步驟:
1. 完成第一階段
2. 配置並開始第二階段
3. 處理約 30% 後模擬失敗
4. 使用「從失敗點繼續執行」

預期結果:
- 確認對話框顯示「第二階段 (OCR 識別)」
- 只處理剩餘的待處理檔案
- 第一階段的結果保持不變
```

### 3. 對比測試

#### 對比 A: 恢復 vs 重新執行
```
測試目的: 驗證兩者的差異

場景 1 - 恢復:
1. 任務執行到 30/100 失敗
2. 使用「從失敗點繼續執行」
3. 記錄處理時間: 約 70 個檔案的時間

場景 2 - 重新執行:
1. 任務執行到 30/100 失敗
2. 使用「從頭重新開始」
3. 記錄處理時間: 約 100 個檔案的時間

結果比較:
- 恢復: 快約 30% (只處理 70 個)
- 重新執行: 處理全部 100 個
- 恢復的前 30 個檔案 processed_at 時間戳不變
```

#### 對比 B: 暫停/恢復 vs 失敗/恢復
```
測試目的: 驗證兩種恢復方式的一致性

場景 1 - 主動暫停:
1. 處理到 30/100
2. 點擊「暫停」
3. 點擊「恢復」
4. 觀察從第 31 個開始

場景 2 - 被動失敗:
1. 處理到 30/100
2. 模擬失敗
3. 點擊「從失敗點繼續執行」
4. 觀察從第 31 個開始

結果: 兩者行為應該一致
```

### 4. 壓力測試

#### 測試 4A: 大量檔案
```
場景: 3000+ 個檔案的任務

步驟:
1. 創建包含 3000 個 PDF 的任務
2. 處理到 1200 個時模擬失敗
3. 使用「從失敗點繼續執行」

觀察項目:
- 記憶體使用是否穩定
- 前端顯示是否正確
- 處理速度是否正常
- 最終結果是否正確(3000 個完成)
```

#### 測試 4B: 多次恢復
```
場景: 多次中斷和恢復

步驟:
1. 任務執行到 30/100,失敗
2. 恢復,執行到 60/100,再次失敗
3. 再次恢復,執行到完成

預期結果:
- 每次恢復都從上次中斷點開始
- 不會重複處理已完成的檔案
- 最終 100 個檔案都完成
```

### 5. 錯誤處理測試

#### 測試 5A: CLIP 服務不可用
```
場景: 恢復時 CLIP 服務仍然不可用

步驟:
1. 任務因 CLIP 服務中斷而失敗
2. 不重啟 CLIP 服務
3. 嘗試「從失敗點繼續執行」

預期結果:
- 處理開始
- 立即再次失敗(CLIP 調用失敗)
- 錯誤訊息清楚說明原因
- 可以修復後再次恢復
```

#### 測試 5B: 資料庫連接問題
```
場景: 資料庫異常

步驟:
1. 模擬資料庫連接中斷
2. 嘗試恢復任務

預期結果:
- 捕獲異常
- 返回錯誤訊息
- 不會導致系統崩潰
```

## 檢查清單

### 功能正確性
- [ ] 恢復後只處理 pending 狀態的檔案
- [ ] 已完成的檔案不會重新處理
- [ ] 已失敗的檔案不會重新處理
- [ ] 進度條正確顯示
- [ ] 最終統計數字正確

### UI/UX
- [ ] 失敗狀態顯示恢復按鈕
- [ ] 確認對話框資訊清楚完整
- [ ] 成功/失敗訊息提示明確
- [ ] 按鈕狀態切換正確

### 性能
- [ ] 大量檔案時記憶體穩定
- [ ] 恢復速度正常
- [ ] 前端頁面不卡頓
- [ ] 資料庫查詢效率高

### 錯誤處理
- [ ] 狀態驗證正確
- [ ] 異常捕獲完整
- [ ] 錯誤訊息清楚
- [ ] 日誌記錄完整

## 常見問題排查

### Q1: 恢復後又立即失敗
```
可能原因:
1. 導致原始失敗的問題未解決(例如 CLIP 服務仍未啟動)
2. 檔案本身有問題

排查步驟:
1. 檢查錯誤訊息
2. 檢查服務日誌
3. 確認外部服務可用
4. 驗證檔案完整性
```

### Q2: 顯示沒有待處理檔案
```
可能原因:
1. 所有檔案都已處理完畢
2. 資料庫狀態不一致

排查步驟:
1. 查詢資料庫統計
   SELECT stage1_status, COUNT(*)
   FROM batch_files
   WHERE task_id='xxx'
   GROUP BY stage1_status;

2. 如果確實有 pending 但無法處理,檢查:
   - task.stage 欄位是否正確
   - stage1_config/stage2_config 是否存在
```

### Q3: 按鈕不顯示
```
可能原因:
1. 任務狀態不是 'failed'
2. 前端快取問題

排查步驟:
1. 刷新頁面
2. 檢查任務狀態
   SELECT status, stage FROM batch_tasks WHERE task_id='xxx';
3. 檢查瀏覽器 console 是否有錯誤
```

## 效能基準

### 預期效能 (3000 個檔案的任務)

| 操作 | 時間 | 記憶體 |
|------|------|--------|
| 頁面載入 | < 3 秒 | < 200 MB |
| 點擊恢復 | < 1 秒 | < 50 MB |
| 開始處理 | < 2 秒 | < 100 MB |
| 處理過程 | 穩定 | < 500 MB |

### 對比數據

| 場景 | 從失敗點繼續 | 從頭重新開始 | 節省 |
|------|------------|------------|------|
| 處理時間 | 1800 個 × 2秒 = 1小時 | 3000 個 × 2秒 = 1.67小時 | 40% |
| API 調用 | 1800 次 | 3000 次 | 40% |
| 資料庫寫入 | 1800 次 | 3000 次 | 40% |

## 總結

測試重點:
1. ✅ 只處理 pending 檔案
2. ✅ 保留已有結果
3. ✅ UI 提示清楚
4. ✅ 錯誤處理完善
5. ✅ 大量檔案穩定

如遇問題,請檢查:
- 服務狀態 (CLIP, PaddleOCR)
- 資料庫狀態
- 日誌輸出
- 錯誤訊息
