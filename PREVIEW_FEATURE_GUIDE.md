# 批次任務處理狀態查看功能說明

## 🎯 新增功能

現在您可以在批次任務管理系統中查看第一階段和第二階段的處理狀態，包括：

1. ✅ **匹配頁面圖片預覽** - 查看 CLIP 找到的最相似頁面
2. ✅ **檔案列表** - 查看所有檔案的處理狀態
3. ✅ **OCR 結果預覽** - 查看提取的關鍵字和識別結果
4. ✅ **全螢幕圖片查看** - 點擊圖片放大查看詳情

## 📱 使用方式

### 方式一：從任務列表進入詳情頁

1. 訪問批次任務管理頁面
   ```
   http://localhost:8080/batch-tasks
   ```

2. 點擊任務卡片選擇要查看的任務

3. 在任務詳情區域，點擊「📊 查看詳情」按鈕

4. 系統會在新分頁開啟任務詳情頁面

### 方式二：直接訪問任務詳情頁

訪問 URL（替換 `{task_id}` 為實際的任務 ID）：
```
http://localhost:8080/batch-tasks/{task_id}/detail
```

## 🖼️ 功能說明

### 1. 圖片預覽標籤頁

**顯示內容**:
- 所有已完成第一階段處理的檔案
- 每個檔案的匹配頁面縮圖
- 匹配頁碼和匹配分數

**操作**:
- 點擊任何圖片查看大圖
- 自動載入前 12 個檔案
- 支援分頁瀏覽

**圖片資訊**:
- 檔案名稱
- 匹配到的頁碼（例如：第 5 頁）
- 匹配分數（0-1 之間，越高越相似）

### 2. 檔案列表標籤頁

**顯示內容**:
- 所有檔案的完整列表
- 每個檔案的處理狀態
- 第一階段和第二階段的狀態

**表格欄位**:
- 檔案名稱
- 匹配頁面
- 匹配分數
- 第一階段狀態（pending/completed/failed）
- 第二階段狀態（pending/completed/failed）
- 操作（查看圖片按鈕）

### 3. OCR 結果標籤頁

**顯示內容**:
- 已完成第二階段處理的檔案
- 提取的關鍵字和對應的值
- OCR 識別的完整資訊

**每個結果包含**:
- 檔案名稱
- 匹配頁面和分數
- 所有配置的關鍵字及其提取值
- 查看原圖按鈕

## 🔍 圖片查看器

點擊任何圖片後會開啟全螢幕查看器：

**顯示資訊**:
- 大尺寸的匹配頁面圖片
- 檔案名稱和完整路徑
- 匹配頁面編號
- 匹配分數（4 位小數）
- 第一階段和第二階段狀態
- 提取的關鍵字（如果第二階段已完成）

**操作**:
- 點擊 ✕ 按鈕或按 ESC 鍵關閉
- 點擊背景區域關閉
- 圖片自動適應螢幕大小

## 📊 統計資訊

詳情頁頂部顯示任務統計：

| 統計項目 | 說明 |
|---------|------|
| 總檔案數 | 任務中的 PDF 總數 |
| 第一階段完成 | 已完成 CLIP 匹配的檔案數 |
| 第二階段完成 | 已完成 OCR 識別的檔案數 |
| 平均匹配分數 | 所有檔案的匹配分數平均值 |

## 🎨 界面特色

### 響應式設計
- 自動適應不同螢幕尺寸
- 網格布局自動調整
- 移動設備友好

### 視覺反饋
- 懸停效果：卡片會升起並顯示陰影
- 載入狀態：顯示載入動畫
- 錯誤處理：圖片載入失敗時顯示佔位符

### 便捷操作
- 分頁切換：點擊標籤快速切換
- 懶載入：按需載入資料
- 快速預覽：縮圖網格一目了然

## 🚀 使用場景

### 場景 1：驗證第一階段結果

**目的**: 確認 CLIP 是否正確找到目標頁面

**步驟**:
1. 進入任務詳情頁
2. 查看「圖片預覽」標籤
3. 檢查每個檔案的匹配頁面
4. 確認匹配分數是否合理（建議 > 0.7）

**如果結果不理想**:
- 調整正例/反例閾值
- 使用更清晰的範本圖片
- 重新執行第一階段

### 場景 2：檢查處理進度

**目的**: 了解任務處理到哪個階段

**步驟**:
1. 進入任務詳情頁
2. 查看統計資訊
3. 切換到「檔案列表」標籤
4. 查看每個檔案的狀態

**狀態說明**:
- `pending`: 待處理
- `completed`: 已完成
- `failed`: 處理失敗

### 場景 3：驗證 OCR 結果

**目的**: 確認關鍵字是否正確提取

**步驟**:
1. 進入任務詳情頁
2. 切換到「OCR 結果」標籤
3. 查看每個檔案提取的關鍵字
4. 點擊「查看原圖」對比確認

**如果提取不準確**:
- 檢查目標頁面是否正確
- 調整 OCR 參數
- 重新配置關鍵字

### 場景 4：匯出前預覽

**目的**: 在匯出 Excel 前先預覽結果

**步驟**:
1. 進入任務詳情頁
2. 查看「OCR 結果」標籤
3. 確認關鍵字提取完整
4. 返回任務列表頁面
5. 點擊「匯出 Excel」

## 🔌 API 端點

### 取得檔案詳情
```http
GET /api/batch-tasks/{task_id}/files/{file_id}
```

**回應**:
```json
{
  "success": true,
  "file": {
    "id": 1,
    "file_name": "document_001.pdf",
    "matched_page_number": 5,
    "matching_score": 0.8532,
    "stage1_status": "completed",
    "stage2_status": "completed",
    "extracted_keywords": {
      "製作日期": "2007/04/10",
      "報告編號": "A123-456"
    }
  }
}
```

### 取得匹配頁面圖片
```http
GET /api/batch-tasks/{task_id}/files/{file_id}/image
```

**回應**: PNG 圖片（二進制資料）

### 取得任務預覽
```http
GET /api/batch-tasks/{task_id}/preview?limit=10
```

**回應**:
```json
{
  "success": true,
  "files": [
    {
      "id": 1,
      "file_name": "document_001.pdf",
      "matched_page_number": 5,
      "matching_score": 0.8532,
      "stage2_status": "completed",
      "has_image": true
    }
  ]
}
```

## 💡 使用技巧

### 技巧 1：快速定位問題檔案

1. 進入「檔案列表」標籤
2. 查看匹配分數欄位
3. 匹配分數 < 0.5 的檔案可能有問題
4. 點擊「查看圖片」確認

### 技巧 2：批量驗證結果

1. 在「圖片預覽」標籤查看所有縮圖
2. 快速瀏覽確認頁面類型是否一致
3. 點擊異常的圖片查看詳情

### 技巧 3：對比原始檔案

1. 記下檔案路徑（顯示在圖片查看器中）
2. 在檔案系統中開啟原始 PDF
3. 對比確認匹配頁碼是否正確

### 技巧 4：追蹤關鍵字提取率

1. 在「OCR 結果」標籤查看
2. 統計有多少檔案成功提取所有關鍵字
3. 找出未找到的關鍵字模式
4. 優化 LLM 提示或 OCR 參數

## 🐛 故障排除

### 問題 1：圖片無法顯示

**可能原因**:
- 第一階段尚未完成
- 圖片資料損壞
- 網路連接問題

**解決方案**:
1. 確認第一階段已完成
2. 檢查瀏覽器控制台錯誤
3. 重新整理頁面
4. 嘗試在無痕模式開啟

### 問題 2：詳情頁面空白

**可能原因**:
- 任務 ID 不存在
- 資料庫連接問題
- JavaScript 錯誤

**解決方案**:
1. 確認任務 ID 正確
2. 檢查瀏覽器控制台
3. 確認服務正常運行
4. 清除瀏覽器快取

### 問題 3：OCR 結果標籤為空

**可能原因**:
- 第二階段尚未完成
- 沒有配置關鍵字
- 關鍵字提取失敗

**解決方案**:
1. 確認第二階段已完成
2. 查看「檔案列表」確認 stage2_status
3. 檢查任務配置是否有關鍵字
4. 查看失敗檔案的錯誤訊息

## 📈 效能優化

### 圖片載入優化

系統已實現：
- **懶載入**: 僅載入當前頁面的圖片
- **限制數量**: 預設每次顯示 12 個檔案
- **錯誤處理**: 載入失敗顯示佔位符

### 資料查詢優化

- 使用分頁查詢避免一次載入過多資料
- 僅在切換標籤時載入對應資料
- 資料庫查詢使用索引加速

### 建議設定

對於大型任務（> 100 個檔案）：
- 增加分頁大小以減少請求次數
- 使用「檔案列表」標籤而非圖片預覽
- 考慮分批處理任務

## 🎓 進階功能

### 自訂顯示數量

修改 JavaScript 中的 `filesPerPage` 變數：
```javascript
const filesPerPage = 20;  // 預設是 12
```

### 匯出特定檔案

在「檔案列表」標籤：
1. 記下需要的檔案 ID
2. 使用 API 直接獲取該檔案資料
3. 自行處理和匯出

### 批量下載圖片

使用腳本批量下載所有匹配頁面：
```python
import requests

task_id = "your-task-id"
files = requests.get(f"http://localhost:8080/api/batch-tasks/{task_id}/preview?limit=100").json()

for file in files['files']:
    file_id = file['id']
    img_data = requests.get(f"http://localhost:8080/api/batch-tasks/{task_id}/files/{file_id}/image").content
    with open(f"page_{file_id}.png", 'wb') as f:
        f.write(img_data)
```

## 🎉 總結

新的處理狀態查看功能讓您能夠：
- ✅ 即時查看每個檔案的處理結果
- ✅ 快速驗證 CLIP 匹配的準確性
- ✅ 預覽 OCR 提取的關鍵字
- ✅ 在匯出前確認資料正確性
- ✅ 追蹤任務處理進度

現在您可以更有信心地使用批次任務管理系統處理大量文件！
